<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë‚´ ì£¼ì‹ ê´€ë¦¬ ğŸ“ˆ</title>
  <style>
    :root {
      --primary:       #1565c0;
      --primary-dark:  #0d47a1;
      --primary-light: #1976d2;
      --accent:        #e3f2fd;
      --bg:            #f0f4f8;
      --white:         #ffffff;
      --border:        #e0e0e0;
      --text:          #212121;
      --text-sub:      #757575;
      --green:         #2e7d32;
      --green-bg:      #e8f5e9;
      --orange:        #e65100;
      --orange-bg:     #fff3e0;
      --red:           #c62828;
      --red-bg:        #ffebee;
      --shadow:        0 2px 10px rgba(0,0,0,.10);
      --radius:        8px;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .header {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary-light));
      color: #fff;
      padding: 14px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 200;
      box-shadow: 0 2px 12px rgba(0,0,0,.25);
    }
    .header-left { display: flex; align-items: center; gap: 14px; }
    .header-left h1 { font-size: 1.4rem; font-weight: 700; letter-spacing: -0.3px; }
    .updated { font-size: 0.78rem; opacity: .75; }
    .header-right { display: flex; gap: 10px; }

    /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn {
      padding: 8px 16px; border: none; border-radius: 6px;
      cursor: pointer; font-size: .85rem; font-weight: 600;
      transition: transform .15s, opacity .15s;
    }
    .btn:hover:not(:disabled) { transform: translateY(-1px); opacity: .9; }
    .btn:disabled { opacity: .55; cursor: not-allowed; }
    .btn-white   { background: #fff; color: var(--primary); }
    .btn-green   { background: #43a047; color: #fff; }
    .btn-orange  { background: #fb8c00; color: #fff; }
    .btn-red     { background: #e53935; color: #fff; }
    .btn-outline { background: transparent; border: 1.5px solid var(--primary); color: var(--primary); }
    .btn-sm      { padding: 4px 10px; font-size: .78rem; border-radius: 4px; }

    /* â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .main { padding: 22px 24px; }

    /* â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .table-wrap {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow-x: auto;
    }
    table { width: 100%; border-collapse: collapse; min-width: 1060px; }
    thead tr { background: var(--primary); color: #fff; }
    th {
      padding: 12px 14px;
      text-align: center;
      font-size: .82rem;
      font-weight: 600;
      white-space: nowrap;
    }
    td {
      padding: 11px 14px;
      text-align: right;
      font-size: .875rem;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
      white-space: nowrap;
    }
    td.l { text-align: left; }
    td.c { text-align: center; }
    tbody tr:hover { background: #f4f8ff; }
    tbody tr:last-child td { border-bottom: none; }

    /* â”€â”€ Price / ratio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .price  { font-weight: 600; }
    .ath    { color: var(--red); font-weight: 600; }
    .dash   { color: #bbb; }
    .badge  {
      display: inline-block; padding: 2px 9px;
      border-radius: 12px; font-size: .78rem; font-weight: 700;
    }
    .badge-g { background: var(--green-bg);  color: var(--green);  }
    .badge-o { background: var(--orange-bg); color: var(--orange); }
    .badge-r { background: var(--red-bg);    color: var(--red);    }

    /* â”€â”€ Spinner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .spin {
      display: inline-block; width: 15px; height: 15px;
      border: 2px solid #ddd; border-top-color: var(--primary);
      border-radius: 50%; animation: rot .7s linear infinite;
      vertical-align: middle;
    }
    @keyframes rot { to { transform: rotate(360deg); } }
    .center-cell { text-align: center; color: var(--text-sub); }

    /* â”€â”€ Modal overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,.48); z-index: 1000;
      align-items: center; justify-content: center;
    }
    .overlay.on { display: flex; }
    .modal {
      background: var(--white); border-radius: var(--radius);
      box-shadow: 0 8px 36px rgba(0,0,0,.22);
      width: 480px; max-width: 95vw; max-height: 90vh;
      overflow-y: auto; animation: pop .2s ease;
    }
    @keyframes pop { from { transform: translateY(-18px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-head {
      display: flex; justify-content: space-between; align-items: center;
      padding: 18px 22px 14px; border-bottom: 1px solid var(--border);
    }
    .modal-head h2 { font-size: 1.05rem; }
    .modal-close {
      background: none; border: none; font-size: 1.6rem;
      cursor: pointer; color: var(--text-sub); line-height: 1;
    }
    .modal-close:hover { color: var(--text); }
    .modal-body { padding: 18px 22px 22px; }

    /* â”€â”€ Form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .fg { margin-bottom: 14px; }
    .fg label {
      display: block; font-size: .82rem;
      font-weight: 600; color: var(--text-sub); margin-bottom: 5px;
    }
    .fg input {
      width: 100%; padding: 9px 11px;
      border: 1px solid var(--border); border-radius: 6px;
      font-size: .9rem; transition: border-color .2s;
    }
    .fg input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(21,101,192,.1); }
    .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 18px; }
    .form-actions .btn { min-width: 76px; }

    /* â”€â”€ Search in modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .search-area { margin-bottom: 18px; padding-bottom: 18px; border-bottom: 1px solid var(--border); }
    .search-area label { display: block; font-size: .82rem; font-weight: 600; color: var(--text-sub); margin-bottom: 7px; }
    .search-row { display: flex; gap: 8px; }
    .search-row input {
      flex: 1; padding: 9px 11px;
      border: 1px solid var(--border); border-radius: 6px; font-size: .9rem;
    }
    .search-row input:focus { outline: none; border-color: var(--primary); }
    .search-results {
      display: none; margin-top: 7px;
      border: 1px solid var(--border); border-radius: 6px;
      max-height: 210px; overflow-y: auto;
    }
    .search-results.on { display: block; }
    .sr-item {
      padding: 8px 12px; cursor: pointer;
      display: flex; gap: 10px; align-items: center;
      font-size: .86rem; border-bottom: 1px solid var(--border);
    }
    .sr-item:last-child { border-bottom: none; }
    .sr-item:hover { background: var(--accent); }
    .sr-code { font-family: monospace; color: var(--primary); font-weight: 700; min-width: 58px; }
    .sr-market {
      font-size: .72rem; color: #fff; background: var(--primary);
      padding: 1px 7px; border-radius: 10px;
    }
    .sr-msg { padding: 12px; text-align: center; color: var(--text-sub); font-size: .85rem; }

    /* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .toast {
      position: fixed; bottom: 22px; right: 22px;
      padding: 11px 20px; border-radius: 7px; color: #fff;
      font-size: .875rem; font-weight: 600; z-index: 9999;
      transform: translateY(60px); opacity: 0;
      transition: all .3s ease; pointer-events: none;
    }
    .toast.on  { transform: translateY(0); opacity: 1; }
    .toast.ok  { background: #43a047; }
    .toast.err { background: #e53935; }
    .toast.inf { background: var(--primary); }

    @media (max-width:640px) {
      .header { flex-direction: column; gap: 10px; }
      .main   { padding: 12px; }
    }
  </style>
</head>
<body>

<!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<header class="header">
  <div class="header-left">
    <h1>ğŸ“ˆ ë‚´ ì£¼ì‹ ê´€ë¦¬</h1>
    <span id="updated" class="updated"></span>
  </div>
  <div class="header-right">
    <button id="refresh-btn" class="btn btn-white" onclick="refreshAll()">ğŸ”„ ì „ì²´ ìƒˆë¡œê³ ì¹¨</button>
    <button class="btn btn-green" onclick="openAddModal()">â• ì¢…ëª© ì¶”ê°€</button>
  </div>
</header>

<!-- â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<main class="main">
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th style="text-align:left">ì¢…ëª©ëª…</th>
          <th>ì¢…ëª©ì½”ë“œ</th>
          <th>í˜„ì¬ê°€</th>
          <th>ì—­ëŒ€ìµœê³ ê°€</th>
          <th>ìµœê³ ê°€ë‹¬ì„±ì¼</th>
          <th>ìµœê³ ê°€ëŒ€ë¹„</th>
          <th>ë³´ìœ ìˆ˜ëŸ‰</th>
          <th>ë§¤ì…ë‹¨ê°€</th>
          <th>ë§¤ë„ê¸°ì¤€ë‹¨ê°€</th>
          <th>ë§¤ë„ë‹¨ê°€<br><small style="font-weight:400;opacity:.85">(ê¸°ì¤€ê°€Ã—90%)</small></th>
          <th>ê´€ë¦¬</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="11" class="center-cell" style="padding:36px"><span class="spin"></span> ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
      </tbody>
    </table>
  </div>
</main>

<!-- â”€â”€ Add Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="add-modal" class="overlay" onclick="closeModal('add-modal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-head">
      <h2>â• ì¢…ëª© ì¶”ê°€</h2>
      <button class="modal-close" onclick="closeModal('add-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="search-area">
        <label>ì¢…ëª©ëª…ìœ¼ë¡œ ê²€ìƒ‰í•˜ì—¬ ì½”ë“œ í™•ì¸</label>
        <div class="search-row">
          <input id="s-input" type="text" placeholder="ì˜ˆ: ì‚¼ì„±, KODEX, SOLâ€¦" oninput="debounce(this.value)">
          <button class="btn btn-outline btn-sm" onclick="doSearch()">ê²€ìƒ‰</button>
        </div>
        <div id="s-results" class="search-results"></div>
      </div>
      <form id="add-form" onsubmit="submitAdd(event)">
        <div class="fg"><label>ì¢…ëª©ì½”ë“œ *</label><input id="a-ticker" placeholder="ì˜ˆ: 005930" required maxlength="6"></div>
        <div class="fg"><label>ì¢…ëª©ëª… *</label><input id="a-name" placeholder="ì˜ˆ: ì‚¼ì„±ì „ì" required></div>
        <div class="fg"><label>ë³´ìœ ìˆ˜ëŸ‰ (ì£¼)</label><input id="a-qty" type="number" min="0" value="0"></div>
        <div class="fg"><label>ë§¤ì…ë‹¨ê°€ (ì›)</label><input id="a-bp" type="number" min="0" value="0"></div>
        <div class="fg"><label>ë§¤ë„ê¸°ì¤€ë‹¨ê°€ (ì›)</label><input id="a-st" type="number" min="0" value="0"></div>
        <div class="form-actions">
          <button type="button" class="btn btn-outline" onclick="closeModal('add-modal')">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-green">ì¶”ê°€</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- â”€â”€ Edit Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="edit-modal" class="overlay" onclick="closeModal('edit-modal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-head">
      <h2 id="edit-title">âœï¸ ë³´ìœ ì •ë³´ ìˆ˜ì •</h2>
      <button class="modal-close" onclick="closeModal('edit-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <form id="edit-form" onsubmit="submitEdit(event)">
        <input type="hidden" id="e-ticker">
        <div class="fg"><label>ë³´ìœ ìˆ˜ëŸ‰ (ì£¼)</label><input id="e-qty" type="number" min="0"></div>
        <div class="fg"><label>ë§¤ì…ë‹¨ê°€ (ì›)</label><input id="e-bp" type="number" min="0"></div>
        <div class="fg"><label>ë§¤ë„ê¸°ì¤€ë‹¨ê°€ (ì›)</label><input id="e-st" type="number" min="0"></div>
        <div class="form-actions">
          <button type="button" class="btn btn-outline" onclick="closeModal('edit-modal')">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-white" style="background:var(--primary);color:#fff">ì €ì¥</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="toast" class="toast"></div>

<script>
  let portfolio = [];

  /* â”€â”€ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function init() {
    try {
      const res = await fetch('/api/portfolio');
      portfolio  = await res.json();
      renderTable();
      portfolio.forEach(item => fetchPrice(item));
    } catch {
      toast('í¬íŠ¸í´ë¦¬ì˜¤ ë¡œë“œ ì‹¤íŒ¨', 'err');
    }
  }

  /* â”€â”€ í…Œì´ë¸” ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function renderTable() {
    const tb = document.getElementById('tbody');
    if (!portfolio.length) {
      tb.innerHTML = '<tr><td colspan="11" class="center-cell" style="padding:36px;color:#aaa">ë“±ë¡ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
      return;
    }
    tb.innerHTML = portfolio.map(rowHTML).join('');
  }

  function rowHTML(item) {
    const sp  = item.sell_target > 0 ? Math.floor(item.sell_target * 0.9) : 0;
    const enc = encodeURIComponent(item.name);
    return `
    <tr id="r-${item.ticker}">
      <td class="l" style="font-weight:600">${item.name}</td>
      <td class="c" style="font-family:monospace;color:var(--text-sub)">${item.ticker}</td>
      <td class="center-cell p-cur"><span class="spin"></span></td>
      <td class="center-cell p-ath"><span class="spin"></span></td>
      <td class="center-cell p-date"><span class="spin"></span></td>
      <td class="center-cell p-ratio"><span class="spin"></span></td>
      <td>${item.quantity > 0 ? num(item.quantity)+'ì£¼' : dash()}</td>
      <td>${item.buy_price  > 0 ? num(item.buy_price)+'ì›'   : dash()}</td>
      <td>${item.sell_target> 0 ? num(item.sell_target)+'ì›' : dash()}</td>
      <td>${sp > 0 ? num(sp)+'ì›' : dash()}</td>
      <td class="c">
        <button class="btn btn-orange btn-sm" style="margin-right:4px"
          onclick="openEdit('${item.ticker}','${item.name.replace(/'/g,"\\'")}',${item.quantity},${item.buy_price},${item.sell_target})">âœï¸</button>
        <button class="btn btn-red btn-sm"
          onclick="delStock('${item.ticker}','${item.name.replace(/'/g,"\\'")}')">ğŸ—‘ï¸</button>
      </td>
    </tr>`;
  }

  /* â”€â”€ ê°€ê²© ì¡°íšŒ (ë¹„ë™ê¸°, ì¢…ëª©ë³„) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function fetchPrice(item) {
    const row = document.getElementById(`r-${item.ticker}`);
    if (!row) return;
    try {
      const res  = await fetch(`/api/stock/${item.ticker}?name=${encodeURIComponent(item.name)}`);
      if (!res.ok) throw 0;
      const info = await res.json();
      row.querySelector('.p-cur').innerHTML  = `<span class="price">${num(info.current_price)}ì›</span>`;
      row.querySelector('.p-ath').innerHTML  = `<span class="ath">${num(info.all_time_high)}ì›</span>`;
      row.querySelector('.p-date').innerHTML = info.all_time_high_date;
      const r   = info.ratio;
      const cls = r >= 90 ? 'badge-g' : r >= 70 ? 'badge-o' : 'badge-r';
      row.querySelector('.p-ratio').innerHTML = `<span class="badge ${cls}">${r}%</span>`;
    } catch {
      ['p-cur','p-ath','p-date','p-ratio'].forEach(c =>
        row.querySelector('.'+c).innerHTML = '<span class="dash">-</span>'
      );
    }
  }

  /* â”€â”€ ì „ì²´ ìƒˆë¡œê³ ì¹¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function refreshAll() {
    const btn = document.getElementById('refresh-btn');
    btn.disabled = true; btn.textContent = 'â³ ì¡°íšŒ ì¤‘â€¦';
    portfolio.forEach(item => {
      const row = document.getElementById(`r-${item.ticker}`);
      if (row) ['p-cur','p-ath','p-date','p-ratio'].forEach(c =>
        row.querySelector('.'+c).innerHTML = '<span class="spin"></span>'
      );
    });
    await Promise.all(portfolio.map(fetchPrice));
    btn.disabled = false; btn.textContent = 'ğŸ”„ ì „ì²´ ìƒˆë¡œê³ ì¹¨';
    const t = new Date();
    document.getElementById('updated').textContent =
      `ìµœê·¼ ì—…ë°ì´íŠ¸: ${t.toLocaleTimeString('ko-KR')}`;
    toast('ì‹œì„¸ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.', 'ok');
  }

  /* â”€â”€ ì¢…ëª© ì¶”ê°€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function openAddModal() {
    document.getElementById('add-form').reset();
    document.getElementById('s-input').value = '';
    const sr = document.getElementById('s-results');
    sr.innerHTML = ''; sr.classList.remove('on');
    document.getElementById('add-modal').classList.add('on');
  }

  async function submitAdd(e) {
    e.preventDefault();
    const body = {
      ticker:      document.getElementById('a-ticker').value.trim(),
      name:        document.getElementById('a-name').value.trim(),
      quantity:    +document.getElementById('a-qty').value || 0,
      buy_price:   +document.getElementById('a-bp').value  || 0,
      sell_target: +document.getElementById('a-st').value  || 0,
    };
    const res  = await fetch('/api/portfolio', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
    const data = await res.json();
    if (!res.ok) { toast(data.error||'ì¶”ê°€ ì‹¤íŒ¨', 'err'); return; }
    closeModal('add-modal');
    toast(`[${body.name}] ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'ok');
    await reload();
  }

  /* â”€â”€ ë³´ìœ ì •ë³´ ìˆ˜ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function openEdit(ticker, name, qty, bp, st) {
    document.getElementById('e-ticker').value = ticker;
    document.getElementById('edit-title').textContent = `âœï¸ ${name} ë³´ìœ ì •ë³´ ìˆ˜ì •`;
    document.getElementById('e-qty').value = qty;
    document.getElementById('e-bp').value  = bp;
    document.getElementById('e-st').value  = st;
    document.getElementById('edit-modal').classList.add('on');
  }

  async function submitEdit(e) {
    e.preventDefault();
    const ticker = document.getElementById('e-ticker').value;
    const body = {
      quantity:    +document.getElementById('e-qty').value || 0,
      buy_price:   +document.getElementById('e-bp').value  || 0,
      sell_target: +document.getElementById('e-st').value  || 0,
    };
    const res  = await fetch(`/api/portfolio/${ticker}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
    const data = await res.json();
    if (!res.ok) { toast(data.error||'ìˆ˜ì • ì‹¤íŒ¨', 'err'); return; }
    closeModal('edit-modal');
    toast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'ok');
    await reload();
  }

  /* â”€â”€ ì¢…ëª© ì‚­ì œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function delStock(ticker, name) {
    if (!confirm(`[${name}] ì¢…ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    const res = await fetch(`/api/portfolio/${ticker}`, { method:'DELETE' });
    if (!res.ok) { toast('ì‚­ì œ ì‹¤íŒ¨', 'err'); return; }
    toast(`[${name}] ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'inf');
    await reload();
  }

  /* â”€â”€ ì¢…ëª© ê²€ìƒ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  let _st = null;
  function debounce(v) {
    clearTimeout(_st);
    if (!v.trim()) { document.getElementById('s-results').classList.remove('on'); return; }
    _st = setTimeout(() => doSearch(v), 500);
  }

  async function doSearch(kw) {
    const q   = kw || document.getElementById('s-input').value.trim();
    if (!q) return;
    const sr  = document.getElementById('s-results');
    sr.innerHTML = '<div class="sr-msg"><span class="spin"></span> ê²€ìƒ‰ ì¤‘â€¦ (ìˆ˜ì´ˆ ì†Œìš”)</div>';
    sr.classList.add('on');
    try {
      const res     = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
      const results = await res.json();
      if (!results.length) { sr.innerHTML = '<div class="sr-msg">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
      sr.innerHTML = results.slice(0,30).map(r => `
        <div class="sr-item" onclick="pickResult('${r.ticker}','${r.name.replace(/'/g,"\\'")}')">
          <span class="sr-code">${r.ticker}</span>
          <span style="flex:1">${r.name}</span>
          <span class="sr-market">${r.market}</span>
        </div>`).join('');
    } catch { sr.innerHTML = '<div class="sr-msg" style="color:#e53935">ê²€ìƒ‰ ì‹¤íŒ¨</div>'; }
  }

  function pickResult(ticker, name) {
    document.getElementById('a-ticker').value = ticker;
    document.getElementById('a-name').value   = name;
    document.getElementById('s-results').classList.remove('on');
    document.getElementById('s-input').value  = '';
  }

  /* â”€â”€ ëª¨ë‹¬ ë‹«ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function closeModal(id) { document.getElementById(id).classList.remove('on'); }
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') { closeModal('add-modal'); closeModal('edit-modal'); }
  });

  /* â”€â”€ ì¬ë¡œë“œ (í¬íŠ¸í´ë¦¬ì˜¤ + ê°€ê²©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function reload() {
    const res = await fetch('/api/portfolio');
    portfolio  = await res.json();
    renderTable();
    portfolio.forEach(fetchPrice);
  }

  /* â”€â”€ ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function num(n)  { return Number(n).toLocaleString('ko-KR'); }
  function dash()  { return '<span class="dash">-</span>'; }

  let _tt = null;
  function toast(msg, type='inf') {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className   = `toast ${type} on`;
    clearTimeout(_tt);
    _tt = setTimeout(() => el.classList.remove('on'), 3200);
  }

  /* â”€â”€ ì‹œì‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  init();
</script>
</body>
</html>
