<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë‚´ ì£¼ì‹ ê´€ë¦¬ ğŸ“ˆ</title>
  <style>
    :root {
      --primary:       #1565c0;
      --primary-dark:  #0d47a1;
      --primary-light: #1976d2;
      --accent:        #e3f2fd;
      --bg:            #f0f4f8;
      --white:         #ffffff;
      --border:        #e0e0e0;
      --text:          #212121;
      --text-sub:      #757575;
      --green:         #2e7d32;
      --green-bg:      #e8f5e9;
      --orange:        #e65100;
      --orange-bg:     #fff3e0;
      --red:           #c62828;
      --red-bg:        #ffebee;
      --shadow:        0 2px 10px rgba(0,0,0,.10);
      --radius:        8px;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif;
      background: var(--bg); color: var(--text); min-height: 100vh;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .header {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary-light));
      color: #fff; padding: 14px 24px;
      display: flex; justify-content: space-between; align-items: center;
      position: sticky; top: 0; z-index: 200;
      box-shadow: 0 2px 12px rgba(0,0,0,.25);
    }
    .header-left { display: flex; align-items: center; gap: 14px; }
    .header-left h1 { font-size: 1.4rem; font-weight: 700; }
    .updated { font-size: .78rem; opacity: .8; }
    .header-right { display: flex; gap: 10px; }

    /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn {
      padding: 8px 16px; border: none; border-radius: 6px;
      cursor: pointer; font-size: .85rem; font-weight: 600;
      transition: transform .15s, opacity .15s;
    }
    .btn:hover:not(:disabled) { transform: translateY(-1px); opacity: .9; }
    .btn:disabled { opacity: .55; cursor: not-allowed; }
    .btn-white   { background: #fff; color: var(--primary); }
    .btn-green   { background: #43a047; color: #fff; }
    .btn-orange  { background: #fb8c00; color: #fff; }
    .btn-red     { background: #e53935; color: #fff; }
    .btn-outline { background: transparent; border: 1.5px solid var(--primary); color: var(--primary); }
    .btn-sm      { padding: 4px 10px; font-size: .78rem; border-radius: 4px; }

    /* â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .main { padding: 22px 24px; }

    /* â”€â”€ Notice bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .notice {
      display: flex; align-items: center; gap: 10px;
      background: var(--orange-bg);
      border-left: 4px solid #fb8c00;
      border-radius: 0 6px 6px 0;
      padding: 10px 16px; margin-bottom: 16px;
      font-size: .84rem; color: var(--orange);
    }
    .notice a { color: var(--orange); font-weight: 700; }

    /* â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .table-wrap {
      background: var(--white); border-radius: var(--radius);
      box-shadow: var(--shadow); overflow-x: auto;
    }
    table { width: 100%; border-collapse: collapse; min-width: 1060px; }
    thead tr { background: var(--primary); color: #fff; }
    th {
      padding: 12px 14px; text-align: center;
      font-size: .82rem; font-weight: 600; white-space: nowrap;
    }
    td {
      padding: 11px 14px; text-align: right;
      font-size: .875rem; border-bottom: 1px solid var(--border);
      vertical-align: middle; white-space: nowrap;
    }
    td.l { text-align: left; }
    td.c { text-align: center; }
    tbody tr:hover { background: #f4f8ff; }
    tbody tr:last-child td { border-bottom: none; }

    /* â”€â”€ Price styles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .price  { font-weight: 600; }
    .ath    { color: var(--red); font-weight: 600; }
    .dash   { color: #bbb; }
    .badge  { display: inline-block; padding: 2px 9px; border-radius: 12px; font-size: .78rem; font-weight: 700; }
    .badge-g { background: var(--green-bg);  color: var(--green); }
    .badge-o { background: var(--orange-bg); color: var(--orange); }
    .badge-r { background: var(--red-bg);    color: var(--red); }
    .badge-x { background: #eeeeee;          color: #9e9e9e; }

    /* â”€â”€ Spinner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .spin {
      display: inline-block; width: 14px; height: 14px;
      border: 2px solid #ddd; border-top-color: var(--primary);
      border-radius: 50%; animation: rot .7s linear infinite; vertical-align: middle;
    }
    @keyframes rot { to { transform: rotate(360deg); } }
    .center-cell { text-align: center; color: var(--text-sub); }

    /* â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,.48); z-index: 1000;
      align-items: center; justify-content: center;
    }
    .overlay.on { display: flex; }
    .modal {
      background: var(--white); border-radius: var(--radius);
      box-shadow: 0 8px 36px rgba(0,0,0,.22);
      width: 500px; max-width: 95vw; max-height: 90vh;
      overflow-y: auto; animation: pop .2s ease;
    }
    @keyframes pop { from { transform: translateY(-18px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-head {
      display: flex; justify-content: space-between; align-items: center;
      padding: 18px 22px 14px; border-bottom: 1px solid var(--border);
    }
    .modal-head h2 { font-size: 1.05rem; }
    .modal-close { background: none; border: none; font-size: 1.6rem; cursor: pointer; color: var(--text-sub); line-height: 1; }
    .modal-close:hover { color: var(--text); }
    .modal-body { padding: 18px 22px 22px; }

    /* â”€â”€ Form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .fg { margin-bottom: 14px; }
    .fg label { display: block; font-size: .82rem; font-weight: 600; color: var(--text-sub); margin-bottom: 5px; }
    .fg input {
      width: 100%; padding: 9px 11px;
      border: 1px solid var(--border); border-radius: 6px; font-size: .9rem;
    }
    .fg input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(21,101,192,.1); }
    .fg .hint { font-size: .76rem; color: var(--text-sub); margin-top: 4px; }
    .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 18px; }

    /* â”€â”€ Add modal tip box â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tip-box {
      background: var(--accent); border-radius: 6px;
      padding: 11px 14px; margin-bottom: 18px; font-size: .83rem; color: #1a237e;
    }
    .tip-box a { color: var(--primary); font-weight: 700; }

    /* â”€â”€ Guide modal pre â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #guide-msg pre {
      background:#f4f8ff; border:1px solid var(--border); border-radius:6px;
      padding:10px 12px; font-size:.82rem; overflow-x:auto;
      margin: 10px 0 10px;
    }
    #guide-msg a { color:var(--primary); font-weight:600; }

    /* â”€â”€ Search in modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .search-area { margin-bottom: 18px; padding-bottom: 18px; border-bottom: 1px solid var(--border); }
    .search-area label { display: block; font-size: .82rem; font-weight: 600; color: var(--text-sub); margin-bottom: 7px; }
    .search-row { display: flex; gap: 8px; }
    .search-row input {
      flex: 1; padding: 9px 11px;
      border: 1px solid var(--border); border-radius: 6px; font-size: .9rem;
    }
    .search-row input:focus { outline: none; border-color: var(--primary); }
    .search-results {
      display: none; margin-top: 7px;
      border: 1px solid var(--border); border-radius: 6px;
      max-height: 210px; overflow-y: auto;
    }
    .search-results.on { display: block; }
    .sr-item {
      padding: 8px 12px; cursor: pointer;
      display: flex; gap: 10px; align-items: center;
      font-size: .86rem; border-bottom: 1px solid var(--border);
    }
    .sr-item:last-child { border-bottom: none; }
    .sr-item:hover { background: var(--accent); }
    .sr-code { font-family: monospace; color: var(--primary); font-weight: 700; min-width: 58px; }
    .sr-market { font-size: .72rem; color: #fff; background: var(--primary); padding: 1px 7px; border-radius: 10px; }
    .sr-msg { padding: 12px; text-align: center; color: var(--text-sub); font-size: .85rem; }

    /* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .toast {
      position: fixed; bottom: 22px; right: 22px;
      padding: 11px 20px; border-radius: 7px; color: #fff;
      font-size: .875rem; font-weight: 600; z-index: 9999;
      transform: translateY(60px); opacity: 0;
      transition: all .3s ease; pointer-events: none;
    }
    .toast.on  { transform: translateY(0); opacity: 1; }
    .toast.ok  { background: #43a047; }
    .toast.err { background: #e53935; }
    .toast.inf { background: var(--primary); }

    @media (max-width: 640px) {
      .header { flex-direction: column; gap: 10px; }
      .main   { padding: 12px; }
    }
  </style>
</head>
<body>

<!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<header class="header">
  <div class="header-left">
    <h1>ğŸ“ˆ ë‚´ ì£¼ì‹ ê´€ë¦¬</h1>
    <span id="updated" class="updated"></span>
  </div>
  <div class="header-right">
    <button id="refresh-btn" class="btn btn-white" onclick="refreshPrices()">ğŸ”„ ì‹œì„¸ ìƒˆë¡œê³ ì¹¨</button>
    <button class="btn btn-green" onclick="openAddModal()">â• ì¢…ëª© ì¶”ê°€</button>
  </div>
</header>

<!-- â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<main class="main">
  <div id="no-data-notice" class="notice" style="display:none">
    â³ ì‹œì„¸ ë°ì´í„°ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤. GitHub Actionsê°€ ìµœì´ˆ ì‹¤í–‰ëœ í›„ ìë™ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤.
    GitHub ì €ì¥ì†Œì˜ <strong>Actions íƒ­</strong>ì—ì„œ <strong>Run workflow</strong>ë¥¼ ëˆŒëŸ¬ ì¦‰ì‹œ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th style="text-align:left">ì¢…ëª©ëª…</th>
          <th>ì¢…ëª©ì½”ë“œ</th>
          <th>í˜„ì¬ê°€</th>
          <th>ì—­ëŒ€ìµœê³ ê°€</th>
          <th>ìµœê³ ê°€ë‹¬ì„±ì¼</th>
          <th>ìµœê³ ê°€ëŒ€ë¹„</th>
          <th>ë³´ìœ ìˆ˜ëŸ‰</th>
          <th>ë§¤ì…ë‹¨ê°€</th>
          <th>ë§¤ë„ê¸°ì¤€ë‹¨ê°€</th>
          <th>ë§¤ë„ë‹¨ê°€<br><small style="font-weight:400;opacity:.85">(ê¸°ì¤€ê°€Ã—90%)</small></th>
          <th>ê´€ë¦¬</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="11" class="center-cell" style="padding:36px"><span class="spin"></span> ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
      </tbody>
    </table>
  </div>
</main>

<!-- â”€â”€ Add Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="add-modal" class="overlay" onclick="closeModal('add-modal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-head">
      <h2>â• ì¢…ëª© ì¶”ê°€</h2>
      <button class="modal-close" onclick="closeModal('add-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="search-area">
        <label>ì¢…ëª©ëª…ìœ¼ë¡œ ê²€ìƒ‰í•˜ì—¬ ì½”ë“œ í™•ì¸</label>
        <div class="search-row">
          <input id="s-input" type="text" placeholder="ì˜ˆ: ì‚¼ì„±, KODEX, SOLâ€¦" oninput="searchDebounce(this.value)">
          <button class="btn btn-outline btn-sm" onclick="doSearch()">ê²€ìƒ‰</button>
        </div>
        <div id="s-results" class="search-results"></div>
      </div>
      <div class="tip-box">
        âš ï¸ ìƒˆ ì¢…ëª© ì¶”ê°€ í›„ ì‹œì„¸ í‘œì‹œë¥¼ ì›í•˜ì‹œë©´ GitHubì˜
        <a href="https://github.com/j5sangyeon/StockManager/edit/main/portfolio.json" target="_blank"><strong>portfolio.json</strong></a>ì—ë„ ì¢…ëª©ì„ ì¶”ê°€í•˜ê³  í‘¸ì‹œí•˜ì„¸ìš”.
        (GitHub Actionsê°€ ìë™ìœ¼ë¡œ ì‹œì„¸ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤)
      </div>
      <form id="add-form" onsubmit="submitAdd(event)">
        <div class="fg">
          <label>ì¢…ëª©ì½”ë“œ *</label>
          <input id="a-ticker" placeholder="ì˜ˆ: 005930" required maxlength="6">
        </div>
        <div class="fg">
          <label>ì¢…ëª©ëª… *</label>
          <input id="a-name" placeholder="ì˜ˆ: ì‚¼ì„±ì „ì" required>
        </div>
        <div class="fg">
          <label>ë³´ìœ ìˆ˜ëŸ‰ (ì£¼)</label>
          <input id="a-qty" type="number" min="0" value="0">
        </div>
        <div class="fg">
          <label>ë§¤ì…ë‹¨ê°€ (ì›)</label>
          <input id="a-bp" type="number" min="0" value="0">
        </div>
        <div class="fg">
          <label>ë§¤ë„ê¸°ì¤€ë‹¨ê°€ (ì›)</label>
          <input id="a-st" type="number" min="0" value="0">
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-outline" onclick="closeModal('add-modal')">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-green">ì¶”ê°€</button>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- â”€â”€ Guide Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="guide-modal" class="overlay" onclick="closeModal('guide-modal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-head">
      <h2>ğŸ“ portfolio.json ì—…ë°ì´íŠ¸ ì•ˆë‚´</h2>
      <button class="modal-close" onclick="closeModal('guide-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <div id="guide-msg"></div>
      <div class="form-actions" style="margin-top:14px">
        <button class="btn btn-outline" onclick="closeModal('guide-modal')">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</div>
<!-- â”€â”€ Edit Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="edit-modal" class="overlay" onclick="closeModal('edit-modal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-head">
      <h2 id="edit-title">âœï¸ ë³´ìœ ì •ë³´ ìˆ˜ì •</h2>
      <button class="modal-close" onclick="closeModal('edit-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <form id="edit-form" onsubmit="submitEdit(event)">
        <input type="hidden" id="e-ticker">
        <div class="fg">
          <label>ë³´ìœ ìˆ˜ëŸ‰ (ì£¼)</label>
          <input id="e-qty" type="number" min="0">
        </div>
        <div class="fg">
          <label>ë§¤ì…ë‹¨ê°€ (ì›)</label>
          <input id="e-bp" type="number" min="0">
        </div>
        <div class="fg">
          <label>ë§¤ë„ê¸°ì¤€ë‹¨ê°€ (ì›)</label>
          <input id="e-st" type="number" min="0">
          <div class="hint">ì…ë ¥í•˜ë©´ ë§¤ë„ë‹¨ê°€(Ã—90%)ê°€ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.</div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-outline" onclick="closeModal('edit-modal')">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-white" style="background:var(--primary);color:#fff">ì €ì¥</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="toast" class="toast"></div>

<script>
  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     ê¸°ë³¸ ì¢…ëª© ëª©ë¡
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const DEFAULT_PORTFOLIO = [
    {ticker:"000660", name:"SKí•˜ì´ë‹‰ìŠ¤",             quantity:0, buy_price:0, sell_target:0},
    {ticker:"028260", name:"ì‚¼ì„±ë¬¼ì‚°",               quantity:0, buy_price:0, sell_target:0},
    {ticker:"064350", name:"í˜„ëŒ€ë¡œí…œ",               quantity:0, buy_price:0, sell_target:0},
    {ticker:"079550", name:"LIGë„¥ìŠ¤ì›",              quantity:0, buy_price:0, sell_target:0},
    {ticker:"140860", name:"íŒŒí¬ì‹œìŠ¤í…œìŠ¤",            quantity:0, buy_price:0, sell_target:0},
    {ticker:"469160", name:"PLUS ê³ ë°°ë‹¹ì£¼",           quantity:0, buy_price:0, sell_target:0},
    {ticker:"449450", name:"SOLê¸ˆìœµì§€ì£¼í”ŒëŸ¬ìŠ¤ê³ ë°°ë‹¹", quantity:0, buy_price:0, sell_target:0},
    {ticker:"411060", name:"ACE KRXê¸ˆí˜„ë¬¼",          quantity:0, buy_price:0, sell_target:0},
    {ticker:"005930", name:"ì‚¼ì„±ì „ì",               quantity:0, buy_price:0, sell_target:0},
  ];

  let portfolio  = [];
  let pricesData = { updated_at: null, prices: {} };

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     localStorage í¬íŠ¸í´ë¦¬ì˜¤ ê´€ë¦¬
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function loadPortfolio() {
    try {
      const s = localStorage.getItem('stock_portfolio');
      return s ? JSON.parse(s) : JSON.parse(JSON.stringify(DEFAULT_PORTFOLIO));
    } catch { return JSON.parse(JSON.stringify(DEFAULT_PORTFOLIO)); }
  }

  function savePortfolio(p) {
    localStorage.setItem('stock_portfolio', JSON.stringify(p));
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     ì‹œì„¸ ë°ì´í„° ë¡œë“œ (data/prices.json)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function loadPrices() {
    try {
      const r = await fetch('data/prices.json?t=' + Date.now());
      if (!r.ok) throw new Error();
      return await r.json();
    } catch { return { updated_at: null, prices: {} }; }
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     í…Œì´ë¸” ë Œë”ë§
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function renderTable() {
    const prices = pricesData.prices || {};
    const tb     = document.getElementById('tbody');

    if (!portfolio.length) {
      tb.innerHTML = '<tr><td colspan="11" class="center-cell" style="padding:36px;color:#aaa">ë“±ë¡ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
      return;
    }

    // ë°ì´í„° ì—†ìŒ ê³µì§€
    const hasAnyPrice = Object.keys(prices).length > 0;
    document.getElementById('no-data-notice').style.display = hasAnyPrice ? 'none' : 'flex';

    // ì—…ë°ì´íŠ¸ ì‹œê° í‘œì‹œ
    if (pricesData.updated_at) {
      document.getElementById('updated').textContent = `ì‹œì„¸ ê¸°ì¤€: ${pricesData.updated_at}`;
    }

    tb.innerHTML = portfolio.map(item => {
      const p  = prices[item.ticker];
      const sp = item.sell_target > 0 ? Math.floor(item.sell_target * 0.9) : 0;

      const curCell  = p ? `<span class="price">${num(p.current_price)}ì›</span>` : dash('ë¯¸ë“±ë¡');
      const athCell  = p ? `<span class="ath">${num(p.all_time_high)}ì›</span>`   : dash();
      const dateCell = p ? p.all_time_high_date                                    : dash();
      let   ratioCell = dash();
      if (p) {
        const r   = p.ratio;
        const cls = r >= 90 ? 'badge-g' : r >= 70 ? 'badge-o' : 'badge-r';
        ratioCell = `<span class="badge ${cls}">${r}%</span>`;
      }

      const qtyCell = item.quantity   > 0 ? num(item.quantity)+'ì£¼'      : dash();
      const bpCell  = item.buy_price  > 0 ? num(item.buy_price)+'ì›'     : dash();
      const stCell  = item.sell_target> 0 ? num(item.sell_target)+'ì›'   : dash();
      const spCell  = sp              > 0 ? `<strong>${num(sp)}ì›</strong>` : dash();

      const safeName = item.name.replace(/'/g, "\\'");
      return `
      <tr>
        <td class="l" style="font-weight:600">${item.name}</td>
        <td class="c" style="font-family:monospace;color:var(--text-sub)">${item.ticker}</td>
        <td class="c">${curCell}</td>
        <td class="c">${athCell}</td>
        <td class="c">${dateCell}</td>
        <td class="c">${ratioCell}</td>
        <td>${qtyCell}</td>
        <td>${bpCell}</td>
        <td>${stCell}</td>
        <td>${spCell}</td>
        <td class="c">
          <button class="btn btn-orange btn-sm" style="margin-right:4px"
            onclick="openEdit('${item.ticker}','${safeName}',${item.quantity},${item.buy_price},${item.sell_target})">âœï¸</button>
          <button class="btn btn-red btn-sm"
            onclick="delStock('${item.ticker}','${safeName}')">ğŸ—‘ï¸</button>
        </td>
      </tr>`;
    }).join('');
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     ì‹œì„¸ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function refreshPrices() {
    const btn = document.getElementById('refresh-btn');
    btn.disabled = true; btn.textContent = 'â³ ë¡œë”© ì¤‘â€¦';
    pricesData = await loadPrices();
    renderTable();
    btn.disabled = false; btn.textContent = 'ğŸ”„ ì‹œì„¸ ìƒˆë¡œê³ ì¹¨';
    toast('ì‹œì„¸ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.', 'ok');
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     ì¢…ëª© ì¶”ê°€
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function openAddModal() {
    document.getElementById('add-form').reset();
    document.getElementById('s-input').value = '';
    const sr = document.getElementById('s-results');
    sr.innerHTML = ''; sr.classList.remove('on');
    document.getElementById('add-modal').classList.add('on');
  }

  function submitAdd(e) {
    e.preventDefault();
    const ticker = document.getElementById('a-ticker').value.trim();
    const name   = document.getElementById('a-name').value.trim();
    if (portfolio.some(i => i.ticker === ticker)) {
      toast('ì´ë¯¸ ë“±ë¡ëœ ì¢…ëª©ì…ë‹ˆë‹¤.', 'err'); return;
    }
    const newItem = {
      ticker,
      name,
      quantity:    +document.getElementById('a-qty').value || 0,
      buy_price:   +document.getElementById('a-bp').value  || 0,
      sell_target: +document.getElementById('a-st').value  || 0,
    };
    portfolio.push(newItem);
    savePortfolio(portfolio);
    renderTable();
    closeModal('add-modal');
    toast(`[${name}] ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'ok');
    // portfolio.json GitHub í¸ì§‘ ì•ˆë‚´
    showPortfolioGuide(newItem);
  }

  function showPortfolioGuide(item) {
    const json = JSON.stringify({ticker:item.ticker, name:item.name, quantity:item.quantity, buy_price:item.buy_price, sell_target:item.sell_target}, null, 2);
    const editUrl = 'https://github.com/j5sangyeon/StockManager/edit/main/portfolio.json';
    const msg = document.getElementById('guide-msg');
    msg.innerHTML =
      `<b>[${item.name}]</b> ì¢…ëª©ì„ ì‹œì„¸ ì—…ë°ì´íŠ¸í•˜ë ¤ë©´ GitHubì˜ ` +
      `<a href="${editUrl}" target="_blank">portfolio.json</a>ì— ì•„ë˜ í•­ëª©ì„ watchlist ë°°ì—´ ë‚œì— ì¶”ê°€í•˜ì„¸ìš”:<br>` +
      `<pre id="guide-json">${json}</pre>` +
      `<button class="btn btn-outline btn-sm" onclick="copyGuideJson()">&#128203; ë³µì‚¬</button>` +
      `&nbsp;<a href="${editUrl}" target="_blank" class="btn btn-green btn-sm" style="text-decoration:none;display:inline-block">GitHubì—ì„œ í¸ì§‘ â†—ï¸</a>`;
    document.getElementById('guide-modal').classList.add('on');
  }

  function copyGuideJson() {
    const text = document.getElementById('guide-json').textContent;
    navigator.clipboard.writeText(text).then(() => toast('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'ok'));
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     ë³´ìœ ì •ë³´ ìˆ˜ì •
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function openEdit(ticker, name, qty, bp, st) {
    document.getElementById('e-ticker').value   = ticker;
    document.getElementById('edit-title').textContent = `âœï¸ ${name} ë³´ìœ ì •ë³´ ìˆ˜ì •`;
    document.getElementById('e-qty').value = qty;
    document.getElementById('e-bp').value  = bp;
    document.getElementById('e-st').value  = st;
    document.getElementById('edit-modal').classList.add('on');
  }

  function submitEdit(e) {
    e.preventDefault();
    const ticker = document.getElementById('e-ticker').value;
    const idx    = portfolio.findIndex(i => i.ticker === ticker);
    if (idx < 0) return;
    portfolio[idx].quantity    = +document.getElementById('e-qty').value || 0;
    portfolio[idx].buy_price   = +document.getElementById('e-bp').value  || 0;
    portfolio[idx].sell_target = +document.getElementById('e-st').value  || 0;
    savePortfolio(portfolio);
    renderTable();
    closeModal('edit-modal');
    toast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'ok');
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     ì¢…ëª© ì‚­ì œ
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function delStock(ticker, name) {
    if (!confirm(`[${name}] ì¢…ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    portfolio = portfolio.filter(i => i.ticker !== ticker);
    savePortfolio(portfolio);
    renderTable();
    toast(`[${name}] ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'inf');
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     ìœ í‹¸
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function closeModal(id) { document.getElementById(id).classList.remove('on'); }
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') { closeModal('add-modal'); closeModal('edit-modal'); closeModal('guide-modal'); }
  });

  /* â”€â”€ ì¢…ëª© ê²€ìƒ‰ (KRX Open API) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  let _searchTimer = null;
  function searchDebounce(v) {
    clearTimeout(_searchTimer);
    const sr = document.getElementById('s-results');
    if (!v.trim()) { sr.innerHTML = ''; sr.classList.remove('on'); return; }
    _searchTimer = setTimeout(() => doSearch(v), 500);
  }

  async function doSearch(kw) {
    const q  = kw || document.getElementById('s-input').value.trim();
    if (!q) return;
    const sr = document.getElementById('s-results');
    sr.innerHTML = '<div class="sr-msg"><span class="spin"></span> ê²€ìƒ‰ ì¤‘â€¦</div>';
    sr.classList.add('on');
    try {
      // KRX Open APIë¡œ ì¢…ëª© ê²€ìƒ‰
      const url = `https://api.stock.naver.com/stock/search?query=${encodeURIComponent(q)}&length=20`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('ê²€ìƒ‰ ì‹¤íŒ¨');
      const json = await res.json();
      const items = json.stocks || json.result || json.items || [];
      if (!items.length) {
        sr.innerHTML = '<div class="sr-msg">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      sr.innerHTML = items.slice(0, 30).map(r => {
        const ticker = r.itemCode || r.code || r.ticker || '';
        const name   = r.itemName || r.name || r.stockName || '';
        const market = r.market   || r.stockExchangeType?.name || '';
        return `<div class="sr-item" onclick="pickResult('${ticker}','${name.replace(/'/g,"\\'")}')">` +
          `<span class="sr-code">${ticker}</span>` +
          `<span style="flex:1">${name}</span>` +
          `<span class="sr-market">${market}</span>` +
          `</div>`;
      }).join('');
    } catch {
      sr.innerHTML = '<div class="sr-msg" style="color:#e53935">ê²€ìƒ‰ ì‹¤íŒ¨ â€” ì¢…ëª©ì½”ë“œë¥¼ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.</div>';
    }
  }

  function pickResult(ticker, name) {
    document.getElementById('a-ticker').value = ticker;
    document.getElementById('a-name').value   = name;
    document.getElementById('s-results').classList.remove('on');
    document.getElementById('s-input').value  = '';
  }

  function num(n)       { return Number(n).toLocaleString('ko-KR'); }
  function dash(t = '-') { return `<span class="dash">${t}</span>`; }

  let _tt = null;
  function toast(msg, type = 'inf') {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className   = `toast ${type} on`;
    clearTimeout(_tt);
    _tt = setTimeout(() => el.classList.remove('on'), 3200);
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     ì´ˆê¸°í™”
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function init() {
    portfolio  = loadPortfolio();
    pricesData = await loadPrices();
    renderTable();
  }

  init();
</script>
</body>
</html>
